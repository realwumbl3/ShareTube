{% extends 'dashboard/base.html' %}
{% set title = 'ShareTube Ops · Rooms' %}
{% block head %}
  <style>
    .rooms { display:grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap:16px; }
    .room { padding:14px; position:relative; overflow:hidden; }
    .room:before { content:""; position:absolute; inset:0; background: radial-gradient(400px 200px at 110% -20%, rgba(124,58,237,.12), transparent 60%); pointer-events:none; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .left .label { color: var(--fg-dim); font-size:11px; text-transform:uppercase; letter-spacing:.7px; }
    .left code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(124,58,237,.12); color:#C8B6FF; padding:2px 6px; border-radius:8px; border:1px solid rgba(124,58,237,.35); }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; letter-spacing:.3px; border:1px solid var(--border); }
    .pill.playing { background: rgba(34,197,94,.12); color:#b7f7c9; border-color: rgba(34,197,94,.35); }
    .pill.idle { background: rgba(100,116,139,.16); color:#cbd5e1; border-color: rgba(100,116,139,.35); }
    .users { display:flex; flex-direction:column; gap:8px; }
    .user { display:flex; align-items:center; gap:10px; padding:8px 10px; background: var(--panel-2); border:1px solid var(--border); border-radius:10px; }
    .avatar { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#0b0f14; background: linear-gradient(135deg, #a78bfa, #34d399); border:1px solid rgba(255,255,255,.2); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .name { font-weight:600; }
    .state { font-size:12px; color: var(--fg-dim); margin-left:auto; display:flex; align-items:center; gap:8px; }
    .badge { font-size:11px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); background: var(--panel-2); color: var(--fg-dim); }
    .badge.playing { background: rgba(34,197,94,.12); color:#b7f7c9; border-color: rgba(34,197,94,.35); }
    .badge.idle { background: rgba(100,116,139,.16); color:#cbd5e1; border-color: rgba(100,116,139,.35); }
    .badge.ad { background: rgba(234,88,12,.18); color:#ffd1b3; border-color: rgba(234,88,12,.45); }
    .state.active { color:#a7f3d0; }
    .metaRow { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .chip { font-size:11px; color:var(--fg-dim); padding:6px 10px; border:1px solid var(--border); border-radius:999px; background: var(--panel-2); }
    .queue { margin-top:12px; }
    .entry { display:flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background: var(--panel); }
    .entry + .entry { margin-top:6px; }
    .thumb { width:64px; height:36px; background:#111; border-radius:6px; object-fit:cover; border:1px solid var(--border); }
    .entryTitle { font-weight:600; }
    .entryUrl { font-size:12px; color: var(--fg-dim); text-overflow:ellipsis; overflow:hidden; white-space:nowrap; }
    .queueHeader { display:flex; align-items:center; justify-content:space-between; margin:8px 0; }
    .queueHeader .label { font-size:12px; color: var(--fg-dim); }
  </style>
{% endblock %}
{% block subright %}—{% endblock %}
{% block content %}
  <div class="metaRow">
    <div class="chip">Real‑time rooms & presence</div>
    <div class="chip">SSE live feed</div>
  </div>
  <div id="rooms" class="rooms"></div>
  <script>
    function getInitials(name) {
      const n = (name || '').trim();
      if (!n) return '?';
      // If contains spaces, use first letters of first two words
      const parts = n.split(/\s+/).filter(Boolean);
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      // CamelCase or multiple capitals in one word
      const caps = (n.match(/[A-Z]/g) || []);
      if (caps.length >= 2) {
        return (caps[0] + caps[1]).toUpperCase();
      }
      // Fallback: first two characters
      const s = n.slice(0, 2).toUpperCase();
      return s.padEnd(2, s[0] || '?');
    }

    function render(snapshot) {
      const tsEl = document.getElementById('ts');
      tsEl.textContent = 'Last update ' + new Date(snapshot.ts).toLocaleString();
      const container = document.getElementById('rooms');
      container.innerHTML = '';
      const rooms = (snapshot && Array.isArray(snapshot.rooms)) ? snapshot.rooms : [];
      if (!rooms.length) {
        const empty = document.createElement('div');
        empty.className = 'panel'; empty.style.padding = '16px'; empty.textContent = 'No active rooms';
        container.appendChild(empty); return;
      }
      for (const room of rooms) {
        const card = document.createElement('div'); card.className = 'panel room';
        const header = document.createElement('div'); header.className = 'header';
        const left = document.createElement('div'); left.className = 'left';
        left.innerHTML = '<div class="label">Room</div><div style="margin-top:4px"><code>' + room.code + '</code></div>';
        const right = document.createElement('div');
        const pill = document.createElement('span'); pill.className = 'pill ' + (room.state === 'playing' ? 'playing' : 'idle');
        pill.textContent = room.state === 'playing' ? 'Playing' : 'Idle'; right.appendChild(pill);
        header.appendChild(left); header.appendChild(right); card.appendChild(header);
        const users = document.createElement('div'); users.className = 'users';
        if (!room.users || !room.users.length) {
          const empty = document.createElement('div'); empty.className = 'sub'; empty.textContent = 'No users'; users.appendChild(empty);
        } else {
          for (const u of room.users) {
            const row = document.createElement('div'); row.className = 'user';
            const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = getInitials(u.name || '');
            const name = document.createElement('div'); name.className = 'name'; name.textContent = u.name || ('User #' + u.id);
            const state = document.createElement('div'); state.className = 'state ' + (u.active ? 'active' : '');
            const basic = document.createElement('span'); basic.textContent = u.active ? 'active' : ('inactive · ' + new Date((u.last_seen||0)*1000).toLocaleTimeString());
            state.appendChild(basic);
            const p = u.player || {};
            const badge = document.createElement('span');
            const st = (p.state === 'playing' || p.state === 'paused' || p.state === 'idle') ? p.state : 'unknown';
            badge.className = 'badge ' + (st === 'playing' ? 'playing' : (st === 'idle' ? 'idle' : ''));
            badge.textContent = st === 'unknown' ? 'player: ?' : ('player: ' + st + (p.is_ad ? ' (AD)' : ''));
            state.appendChild(badge);
            row.appendChild(avatar); row.appendChild(name); row.appendChild(state); users.appendChild(row);
          }
        }
        card.appendChild(users);

        // Queue section
        const queueWrap = document.createElement('div'); queueWrap.className = 'queue';
        const qHeader = document.createElement('div'); qHeader.className = 'queueHeader';
        const qLabel = document.createElement('div'); qLabel.className = 'label';
        const entries = Array.isArray(room.entries) ? room.entries : [];
        qLabel.textContent = 'Queue ' + (room.queue && room.queue.id ? ('#' + room.queue.id) : '(none)') + ' · ' + entries.length + ' item' + (entries.length === 1 ? '' : 's');
        qHeader.appendChild(qLabel); queueWrap.appendChild(qHeader);
        if (entries.length === 0) {
          const empty = document.createElement('div'); empty.className = 'sub'; empty.textContent = 'No entries'; queueWrap.appendChild(empty);
        } else {
          for (const it of entries) {
            const row = document.createElement('div'); row.className = 'entry';
            const pos = document.createElement('div'); pos.className = 'chip'; pos.textContent = String((it.position ?? 0) + 1);
            const img = document.createElement('img'); img.className = 'thumb'; img.loading = 'lazy'; img.alt = '';
            img.src = it.thumbnail_url || '';
            const meta = document.createElement('div'); meta.style.flex = '1 1 auto';
            const title = document.createElement('div'); title.className = 'entryTitle'; title.textContent = it.title || '(no title)';
            const url = document.createElement('div'); url.className = 'entryUrl'; url.textContent = it.url || '';
            meta.appendChild(title); meta.appendChild(url);
            row.appendChild(pos); row.appendChild(img); row.appendChild(meta);
            queueWrap.appendChild(row);
          }
        }
        card.appendChild(queueWrap);
        container.appendChild(card);
      }
    }
    function boot() {
      fetch('/dashboard/api/snapshot').then(r => r.json()).then(render).catch(console.warn);
      try {
        const ev = new EventSource('/dashboard/stream');
        ev.onmessage = (e) => { try { render(JSON.parse(e.data)); } catch (err) { console.warn(err); } };
      } catch (e) { console.warn('SSE not available', e); }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else { boot(); }
  </script>
{% endblock %}
