{% extends 'dashboard/base.html' %}
{% set title = 'ShareTube Ops · Rooms' %}
{% block head %}
  <style>
    .rooms { display:grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap:16px; }
    .room { padding:14px; position:relative; overflow:hidden; }
    .room:before { content:""; position:absolute; inset:0; background: radial-gradient(400px 200px at 110% -20%, rgba(124,58,237,.12), transparent 60%); pointer-events:none; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .left .label { color: var(--fg-dim); font-size:11px; text-transform:uppercase; letter-spacing:.7px; }
    .left code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: rgba(124,58,237,.12); color:#C8B6FF; padding:2px 6px; border-radius:8px; border:1px solid rgba(124,58,237,.35); }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; letter-spacing:.3px; border:1px solid var(--border); }
    .pill.playing { background: rgba(34,197,94,.12); color:#b7f7c9; border-color: rgba(34,197,94,.35); }
    .pill.idle { background: rgba(100,116,139,.16); color:#cbd5e1; border-color: rgba(100,116,139,.35); }
    .users { display:flex; flex-direction:column; gap:8px; }
    .user { display:flex; align-items:center; gap:10px; padding:8px 10px; background: var(--panel-2); border:1px solid var(--border); border-radius:10px; }
    .avatar { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#0b0f14; background: linear-gradient(135deg, #a78bfa, #34d399); border:1px solid rgba(255,255,255,.2); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .name { font-weight:600; }
    .state { font-size:12px; color: var(--fg-dim); margin-left:auto; }
    .state.active { color:#a7f3d0; }
    .metaRow { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .chip { font-size:11px; color:var(--fg-dim); padding:6px 10px; border:1px solid var(--border); border-radius:999px; background: var(--panel-2); }
  </style>
{% endblock %}
{% block subright %}—{% endblock %}
{% block content %}
  <div class="metaRow">
    <div class="chip">Real‑time rooms & presence</div>
    <div class="chip">SSE live feed</div>
  </div>
  <div id="rooms" class="rooms"></div>
  <script>
    function getInitials(name) {
      const n = (name || '').trim();
      if (!n) return '?';
      // If contains spaces, use first letters of first two words
      const parts = n.split(/\s+/).filter(Boolean);
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      // CamelCase or multiple capitals in one word
      const caps = (n.match(/[A-Z]/g) || []);
      if (caps.length >= 2) {
        return (caps[0] + caps[1]).toUpperCase();
      }
      // Fallback: first two characters
      const s = n.slice(0, 2).toUpperCase();
      return s.padEnd(2, s[0] || '?');
    }

    function render(snapshot) {
      const tsEl = document.getElementById('ts');
      tsEl.textContent = 'Last update ' + new Date(snapshot.ts).toLocaleString();
      const container = document.getElementById('rooms');
      container.innerHTML = '';
      const rooms = (snapshot && Array.isArray(snapshot.rooms)) ? snapshot.rooms : [];
      if (!rooms.length) {
        const empty = document.createElement('div');
        empty.className = 'panel'; empty.style.padding = '16px'; empty.textContent = 'No active rooms';
        container.appendChild(empty); return;
      }
      for (const room of rooms) {
        const card = document.createElement('div'); card.className = 'panel room';
        const header = document.createElement('div'); header.className = 'header';
        const left = document.createElement('div'); left.className = 'left';
        left.innerHTML = '<div class="label">Room</div><div style="margin-top:4px"><code>' + room.code + '</code></div>';
        const right = document.createElement('div');
        const pill = document.createElement('span'); pill.className = 'pill ' + (room.state === 'playing' ? 'playing' : 'idle');
        pill.textContent = room.state === 'playing' ? 'Playing' : 'Idle'; right.appendChild(pill);
        header.appendChild(left); header.appendChild(right); card.appendChild(header);
        const users = document.createElement('div'); users.className = 'users';
        if (!room.users || !room.users.length) {
          const empty = document.createElement('div'); empty.className = 'sub'; empty.textContent = 'No users'; users.appendChild(empty);
        } else {
          for (const u of room.users) {
            const row = document.createElement('div'); row.className = 'user';
            const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.textContent = getInitials(u.name || '');
            const name = document.createElement('div'); name.className = 'name'; name.textContent = u.name || ('User #' + u.id);
            const state = document.createElement('div'); state.className = 'state ' + (u.active ? 'active' : '');
            state.textContent = u.active ? 'active' : ('inactive · ' + new Date((u.last_seen||0)*1000).toLocaleTimeString());
            row.appendChild(avatar); row.appendChild(name); row.appendChild(state); users.appendChild(row);
          }
        }
        card.appendChild(users); container.appendChild(card);
      }
    }
    function boot() {
      fetch('/dashboard/api/snapshot').then(r => r.json()).then(render).catch(console.warn);
      try {
        const ev = new EventSource('/dashboard/stream');
        ev.onmessage = (e) => { try { render(JSON.parse(e.data)); } catch (err) { console.warn(err); } };
      } catch (e) { console.warn('SSE not available', e); }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else { boot(); }
  </script>
{% endblock %}
